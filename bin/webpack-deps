#!/usr/bin/env node

var fs = require('fs');
var path = require('path');
var _ = require('lodash');
var yargs = require('yargs')
              .usage('Usage: \n$0 [stats.json file] --from [array of file names]\n\n or alternatively: \n\n[array of file names] | $0 [stats.json file]')
              .alias('f', 'from')
              .array('f')
              .alias('d', 'dependencies')
              .boolean('d')
              .alias('D', 'dependents')
              .boolean('D')
              .alias('c', 'count')
              .boolean('c')
              .alias('h', 'help')
              .help();
var argv = yargs.argv;

var webpackDeps = require('../index');

var statsFileName = argv._[0] || 'webpack-stats.json';
var statsFilePath = path.join(process.cwd(), statsFileName);

// why bother with callbacks when you can block?
var stats = JSON.parse(fs.readFileSync(statsFilePath, 'utf8'));

function formatFileNames(files) {
  return files.map(function(file) {
    return './' + path.join('.', file);
  });
}

function writeOut(arr) {
  arr.forEach(function(d) {
    process.stdout.write(d + '\n');
  });
}

function findDeps(filesToCheck, depsMap) {
  writeOut(webpackDeps.getAllDependentsForFiles(formatFileNames(filesToCheck), depsMap));
}

function outputDependentCount(startFrom, depsMap) {
  startFrom = startFrom || Object.keys(depsMap);
  writeOut(startFrom.map(function(d) {
    return '' + (depsMap[d] ? depsMap[d].length : 0) + '\t' +  d;
  }));
}

function output(startFrom) {
  startFrom = formatFileNames(startFrom);

  var depGetter = argv.dependencies ? 'getDependenciesMap' : 'getDependentsMap';
  console.log(argv.dependencies);
  var depsMap = webpackDeps[depGetter](stats);

  if (argv.count) {
    outputDependentCount(startFrom, depsMap);
  } else {
    findDeps(startFrom, depsMap);
  }
}

if (argv.from) {
  output(argv.from);
} else {
  var input = [];
  var inputCheck;

  process.stdin.setEncoding('utf8');
  process.stdin.on('data', function(data) {
    input = input.concat(data.split('\n'));
  });

  inputCheck = setTimeout(function() {
    process.stdin.pause()
    yargs.parse(['--help']);
  }, 100);

  process.stdin.on('end', function() {
    clearTimeout(inputCheck);

    output(input);
  });
}
